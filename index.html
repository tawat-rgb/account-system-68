<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบัญชีรายรับ-รายจ่าย คณะสีฟ้าเพชรไพลิน</title>
    <!-- โหลด Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ตั้งค่าธีม Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'blue-sapphire': '#0F52BA', // สีฟ้าเพชรไพลิน
                        'income': '#10B981', // Emerald 500
                        'expense': '#EF4444', // Red 500
                        'primary-bg': '#F3F4F6', // Gray 100
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* สไตล์สำหรับปุ่ม */
        .btn-base {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }
        .btn-base:hover {
            transform: translateY(-1px);
        }
        .btn-base:active {
            transform: translateY(1px);
        }
        /* สไตล์สำหรับฟอร์ม */
        .input-field {
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #D1D5DB;
            width: 100%;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-field:focus {
            border-color: #0F52BA;
            box-shadow: 0 0 0 1px #0F52BA;
            outline: none;
        }
    </style>
</head>
<body class="bg-primary-bg min-h-screen font-sans">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-sapphire mb-2">ระบบบัญชีคณะสีฟ้าเพชรไพลิน</h1>
            <p class="text-gray-600">บันทึกและติดตามรายรับ-รายจ่ายแบบเรียลไทม์สำหรับกีฬาปากเกร็ดเกมส์</p>
            <p id="user-info" class="text-sm text-gray-400 mt-2">กำลังโหลดข้อมูลผู้ใช้...</p>
        </header>

        <!-- ส่วนแสดงยอดคงเหลือรวม -->
        <div id="balance-card" class="bg-white p-6 rounded-xl shadow-lg mb-8 text-center transition-all duration-300">
            <p class="text-xl text-gray-500 mb-2">ยอดคงเหลือปัจจุบัน</p>
            <h2 id="total-balance" class="text-5xl font-extrabold text-blue-sapphire">...</h2>
        </div>

        <!-- ส่วนฟอร์มเพิ่มรายการ -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">เพิ่มรายการใหม่</h3>
            <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                <div class="md:col-span-1">
                    <label for="date" class="block text-sm font-medium text-gray-700 mb-1">วันที่</label>
                    <input type="date" id="date" class="input-field" required value="">
                </div>
                <div class="md:col-span-2">
                    <label for="description" class="block text-sm font-medium text-gray-700 mb-1">รายละเอียด</label>
                    <input type="text" id="description" class="input-field" placeholder="เช่น ค่าจ้างเชียร์ลีดเดอร์, เงินบริจาคม.5/3" required>
                </div>
                <div class="md:col-span-1">
                    <label for="amount" class="block text-sm font-medium text-gray-700 mb-1">จำนวนเงิน (บาท)</label>
                    <input type="number" id="amount" class="input-field" placeholder="1000.00" min="0.01" step="0.01" required>
                </div>
                <div class="md:col-span-1 flex flex-col">
                    <label for="type" class="block text-sm font-medium text-gray-700 mb-1">ประเภท</label>
                    <select id="type" class="input-field h-[48px]" required>
                        <option value="Income">รายรับ</option>
                        <option value="Expense">รายจ่าย</option>
                    </select>
                </div>
                <div class="md:col-span-5">
                    <button type="submit" id="submit-button" class="btn-base w-full bg-blue-sapphire text-white hover:bg-blue-600 focus:ring-4 focus:ring-blue-300">
                        บันทึกรายการ
                    </button>
                </div>
            </form>
            <p id="error-message" class="text-expense text-sm mt-3 hidden"></p>
        </div>

        <!-- ส่วนแสดงรายการธุรกรรม -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <h3 class="text-2xl font-semibold text-gray-800 mb-4">รายการทั้งหมด</h3>
            <div id="transaction-list" class="space-y-3">
                <p id="loading-indicator" class="text-center text-gray-500">กำลังโหลดรายการ...</p>
                <!-- รายการจะถูกแทรกที่นี่โดย JavaScript -->
            </div>
        </div>

    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, deleteDoc, doc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ตั้งค่า Logging เป็น Debug
        setLogLevel('Debug');

        // ข้อมูล Global จากสภาพแวดล้อม Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        const TOTAL_BALANCE_ELEM = document.getElementById('total-balance');
        const USER_INFO_ELEM = document.getElementById('user-info');
        const TRANSACTION_LIST_ELEM = document.getElementById('transaction-list');
        const LOADING_INDICATOR = document.getElementById('loading-indicator');
        const ERROR_MESSAGE_ELEM = document.getElementById('error-message');

        // ฟังก์ชันสำหรับฟอร์แมตตัวเลขให้เป็นสกุลเงิน
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat('th-TH', {
                style: 'currency',
                currency: 'THB',
                minimumFractionDigits: 2
            }).format(amount);
        };

        // ฟังก์ชันสำหรับฟอร์แมตวันที่
        const formatDate = (timestamp) => {
            if (timestamp && timestamp.toDate) {
                return timestamp.toDate().toLocaleDateString('th-TH', {
                    year: 'numeric', month: 'short', day: 'numeric'
                });
            }
            return '-';
        };

        // 1. การตั้งค่า Firebase และการยืนยันตัวตน
        const initializeFirebase = async () => {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // ตั้งค่าวันที่เริ่มต้นเป็นวันปัจจุบันในฟอร์ม
                document.getElementById('date').valueAsDate = new Date();

                // การยืนยันตัวตน (Authentication)
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        USER_INFO_ELEM.textContent = `ผู้ใช้ปัจจุบัน (ID): ${userId}`;
                    } else {
                        // หากไม่มีผู้ใช้ ให้ลงชื่อเข้าใช้ด้วย token หรือแบบไม่ระบุตัวตน
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // ใช้การลงชื่อเข้าใช้แบบไม่ระบุตัวตน (Anonymous) หากไม่มี Token
                            await signInAnonymously(auth);
                            userId = auth.currentUser?.uid || crypto.randomUUID();
                            USER_INFO_ELEM.textContent = `ผู้ใช้ปัจจุบัน (Anonymous ID): ${userId}`;
                        }
                    }
                    isAuthReady = true;
                    // เมื่อ Auth พร้อมแล้ว ให้เริ่มฟังการเปลี่ยนแปลงของข้อมูล
                    startRealtimeListener();
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                USER_INFO_ELEM.textContent = "เกิดข้อผิดพลาดในการเชื่อมต่อระบบบัญชี";
            }
        };

        // 2. การฟังข้อมูลแบบ Real-time จาก Firestore
        const startRealtimeListener = () => {
            if (!isAuthReady || !db) return;

            // กำหนด Collection Path เป็น Public Data: /artifacts/{appId}/public/data/blue_sapphire_finances
            const collectionPath = `artifacts/${appId}/public/data/blue_sapphire_finances`;
            const transactionsCol = collection(db, collectionPath);
            
            // สร้าง Query เพื่อดึงรายการทั้งหมดเรียงตามวันที่ (timestamp) ล่าสุดขึ้นก่อน
            const q = query(transactionsCol, orderBy("timestamp", "desc"));

            // เริ่มฟังการเปลี่ยนแปลงแบบ Real-time
            onSnapshot(q, (snapshot) => {
                let totalBalance = 0;
                let listHtml = '';

                if (snapshot.empty) {
                    listHtml = '<p class="text-center text-gray-500">ยังไม่มีรายการบันทึก</p>';
                } else {
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        const isIncome = data.type === 'Income';
                        const amount = parseFloat(data.amount);

                        // คำนวณยอดคงเหลือรวม
                        totalBalance += isIncome ? amount : -amount;

                        // สร้าง HTML สำหรับแสดงรายการ
                        listHtml += createTransactionItem(doc.id, data, isIncome);
                    });
                }

                // อัปเดตยอดคงเหลือรวม
                TOTAL_BALANCE_ELEM.textContent = formatCurrency(totalBalance);
                TOTAL_BALANCE_ELEM.className = `text-5xl font-extrabold ${totalBalance >= 0 ? 'text-income' : 'text-expense'}`;
                
                // อัปเดตรายการธุรกรรม
                TRANSACTION_LIST_ELEM.innerHTML = listHtml;
                LOADING_INDICATOR.style.display = 'none';

                // ผูก Event Listener สำหรับปุ่มลบ
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.onclick = (e) => handleDelete(e.target.dataset.id);
                });

            }, (error) => {
                console.error("Error listening to transactions:", error);
                ERROR_MESSAGE_ELEM.textContent = "เกิดข้อผิดพลาดในการโหลดรายการบัญชี";
                ERROR_MESSAGE_ELEM.classList.remove('hidden');
            });
        };

        // สร้าง Element รายการ
        const createTransactionItem = (id, data, isIncome) => {
            const amountText = formatCurrency(data.amount);
            const amountColor = isIncome ? 'text-income' : 'text-expense';
            const typeLabel = isIncome ? 'รายรับ' : 'รายจ่าย';
            const icon = isIncome ? '&#x25B2;' : '&#x25BC;'; // ▲ หรือ ▼

            return `
                <div class="flex items-center justify-between p-4 bg-primary-bg rounded-lg shadow-sm hover:shadow-md transition-shadow">
                    <div class="flex items-center space-x-4 min-w-0">
                        <span class="text-xl ${amountColor}">${icon}</span>
                        <div class="min-w-0">
                            <p class="font-semibold text-gray-900 truncate">${data.description}</p>
                            <p class="text-xs text-gray-500">วันที่: ${formatDate(data.timestamp)} | ผู้บันทึก: ${data.userId.substring(0, 8)}...</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-bold text-lg ${amountColor} md:w-32 text-right">${amountText}</span>
                        <button data-id="${id}" class="delete-btn text-gray-400 hover:text-expense transition-colors" title="ลบรายการ">
                            <svg data-id="${id}" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            `;
        };

        // 3. การเพิ่มรายการใหม่
        document.getElementById('transaction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!userId || !db) return;

            ERROR_MESSAGE_ELEM.classList.add('hidden');
            
            const form = e.target;
            const description = form.description.value.trim();
            const amount = parseFloat(form.amount.value);
            const type = form.type.value;
            const dateStr = form.date.value; // YYYY-MM-DD

            if (!description || isNaN(amount) || amount <= 0) {
                ERROR_MESSAGE_ELEM.textContent = "กรุณากรอกข้อมูลให้ครบถ้วนและจำนวนเงินต้องมากกว่า 0";
                ERROR_MESSAGE_ELEM.classList.remove('hidden');
                return;
            }

            const newTransaction = {
                date: dateStr,
                description: description,
                amount: amount,
                type: type,
                timestamp: serverTimestamp(), // ใช้ Server Timestamp สำหรับการเรียงลำดับและเวลาที่บันทึกจริง
                userId: userId,
            };

            const submitButton = document.getElementById('submit-button');
            submitButton.disabled = true;
            submitButton.textContent = 'กำลังบันทึก...';
            
            try {
                const collectionPath = `artifacts/${appId}/public/data/blue_sapphire_finances`;
                await addDoc(collection(db, collectionPath), newTransaction);
                
                // ล้างฟอร์มยกเว้นวันที่
                form.description.value = '';
                form.amount.value = '';
                form.type.value = 'Income';
                
            } catch (error) {
                console.error("Error adding document:", error);
                ERROR_MESSAGE_ELEM.textContent = "บันทึกรายการไม่สำเร็จ: " + error.message;
                ERROR_MESSAGE_ELEM.classList.remove('hidden');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'บันทึกรายการ';
            }
        });

        // 4. การลบรายการ
        const handleDelete = async (docId) => {
            if (!userId || !db) return;
            
            // แสดงกล่องข้อความยืนยันการลบ
            if (confirm("คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้?")) {
                try {
                    const collectionPath = `artifacts/${appId}/public/data/blue_sapphire_finances`;
                    await deleteDoc(doc(db, collectionPath, docId));
                    // ไม่ต้องอัปเดต UI ด้วยตนเอง เพราะ onSnapshot จะจัดการให้
                } catch (error) {
                    console.error("Error removing document: ", error);
                    alert("ลบรายการไม่สำเร็จ: " + error.message);
                }
            }
        };

        // เริ่มต้นระบบเมื่อหน้าเว็บโหลด
        initializeFirebase();

        // ฟังก์ชันง่ายๆ สำหรับกล่องข้อความยืนยัน (แทน confirm())
        function confirm(message) {
            return window.confirm(message); // ใช้ window.confirm() เพื่อให้ทำงานใน Canvas
        }

        // ฟังก์ชันง่ายๆ สำหรับกล่องข้อความแจ้งเตือน (แทน alert())
        function alert(message) {
            window.alert(message); // ใช้ window.alert() เพื่อให้ทำงานใน Canvas
        }
    </script>
</body>
</html>